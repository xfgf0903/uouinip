name: Update Telecom IPs

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´ UTC+8)
    - cron: '0 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'

env:
  PYTHON_VERSION: '3.9'

jobs:
  update-ips:
    name: æ›´æ–°ç”µä¿¡ä¼˜é€‰IP
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: åˆ›å»ºæ—¥å¿—ç›®å½•
      run: mkdir -p logs

    - name: è¿è¡ŒIPæ›´æ–°è„šæœ¬
      run: |
        python main.py

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        ls -la
        if [ -f telecom_ips.txt ]; then
          echo "telecom_ips.txt å†…å®¹:"
          cat telecom_ips.txt
          echo "IPæ•°é‡: $(wc -l < telecom_ips.txt)"
        else
          echo "telecom_ips.txt ä¸å­˜åœ¨"
        fi

    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: git-check
      run: |
        git add telecom_ips.txt telecom_ips.json logs/
        echo "changes=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT

    - name: é…ç½®Gitç”¨æˆ·
      if: steps.git-check.outputs.changes != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: æäº¤æ›´æ”¹
      if: steps.git-check.outputs.changes != '0'
      run: |
        git add telecom_ips.txt telecom_ips.json logs/
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç”µä¿¡ä¼˜é€‰IP - $(date +'%Y-%m-%d %H:%M')"
        git push

    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ip-updater-logs
        path: |
          logs/
          telecom_ips.txt
          telecom_ips.json
        retention-days: 3
