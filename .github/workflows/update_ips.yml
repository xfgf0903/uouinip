name: Update Telecom IPs

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'

env:
  PYTHON_VERSION: '3.9'

jobs:
  update-ips:
    name: æ›´æ–°ç”µä¿¡ä¼˜é€‰IP
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: è¿è¡ŒIPæ›´æ–°è„šæœ¬
      run: |
        python main.py

    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: git-check
      run: |
        git add telecom_ips.txt
        echo "::set-output name=changes::$(git status --porcelain | wc -l)"

    - name: é…ç½®Gitç”¨æˆ·
      if: steps.git-check.outputs.changes != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: æäº¤æ›´æ”¹
      if: steps.git-check.outputs.changes != '0'
      run: |
        git add telecom_ips.txt
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç”µä¿¡ä¼˜é€‰IP - $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push

    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: ip-updater-logs
        path: ip_updater.log
        retention-days: 7

    - name: å‘é€é€šçŸ¥ (å¯é€‰)
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: ç”µä¿¡IPæ›´æ–°ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
