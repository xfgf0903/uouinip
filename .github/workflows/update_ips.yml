name: Update Telecom IPs

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´ UTC+8)
    - cron: '0 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'telecom_ips.txt'
      - 'telecom_ips.json'
      - 'logs/**'

env:
  PYTHON_VERSION: '3.9'
  TZ: 'Asia/Shanghai'

jobs:
  update-ips:
    name: æ›´æ–°ç”µä¿¡ä¼˜é€‰IP
    runs-on: ubuntu-latest
    
    steps:
    - name: è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        echo "å½“å‰æ—¶é—´: $(date)"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…Chromeæµè§ˆå™¨
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install selenium beautifulsoup4 lxml requests

    - name: åˆ›å»ºæ—¥å¿—ç›®å½•
      run: mkdir -p logs

    - name: è¿è¡ŒIPæ›´æ–°è„šæœ¬
      run: |
        python main.py

    - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        echo "æ—¥å¿—ç›®å½•æ–‡ä»¶:"
        ls -la logs/ || echo "æ—¥å¿—ç›®å½•ä¸å­˜åœ¨"

    - name: æ˜¾ç¤ºIPæ–‡ä»¶å†…å®¹é¢„è§ˆ
      run: |
        if [ -f telecom_ips.txt ]; then
          echo "=== telecom_ips.txt å†…å®¹é¢„è§ˆ ==="
          head -10 telecom_ips.txt
          echo "æ€»IPæ•°é‡: $(wc -l < telecom_ips.txt)"
        else
          echo "telecom_ips.txt æ–‡ä»¶ä¸å­˜åœ¨"
        fi

    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: git-check
      run: |
        git add telecom_ips.txt telecom_ips.json logs/
        echo "changes=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT
        echo "æ–‡ä»¶å˜åŒ–æ•°é‡: $(git status --porcelain | wc -l)"

    - name: é…ç½®Gitç”¨æˆ·
      if: steps.git-check.outputs.changes != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: æäº¤æ›´æ”¹
      if: steps.git-check.outputs.changes != '0'
      run: |
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
        git add telecom_ips.txt telecom_ips.json logs/
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç”µä¿¡ä¼˜é€‰IP - ${BEIJING_TIME} åŒ—äº¬æ—¶é—´
        
        - ä½¿ç”¨Seleniumæ¨¡æ‹Ÿæµè§ˆå™¨
        - éšæœºå»¶è¿Ÿç­‰å¾…é¡µé¢åŠ è½½
        - æ›´æ–°IPåœ°å€åˆ—è¡¨"
        git push

    - name: ä¸Šä¼ æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ip-updater-logs
        path: |
          logs/
          telecom_ips.txt
          telecom_ips.json
        retention-days: 7
        if-no-files-found: warn

    - name: æ˜¾ç¤ºä»»åŠ¡æ‘˜è¦
      run: |
        echo "=== ä»»åŠ¡æ‰§è¡Œæ‘˜è¦ ==="
        echo "è¿è¡Œæ—¶é—´(åŒ—äº¬æ—¶é—´): $(TZ='Asia/Shanghai' date)"
        echo "æ–‡ä»¶å˜åŒ–: ${{ steps.git-check.outputs.changes }}"
        if [ -f telecom_ips.txt ]; then
          IP_COUNT=$(wc -l < telecom_ips.txt)
          echo "ç”Ÿæˆçš„IPæ•°é‡: $IP_COUNT"
          echo "IPæ–‡ä»¶æ ¼å¼: çº¯æ–‡æœ¬ï¼Œæ¯è¡Œä¸€ä¸ªIP"
          echo "ä½¿ç”¨æŠ€æœ¯: Selenium + éšæœºå»¶è¿Ÿ"
        else
          echo "IPæ–‡ä»¶æœªç”Ÿæˆ"
        fi

    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: success() && steps.git-check.outputs.changes != '0'
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
        echo "âœ… ç”µä¿¡IPæ›´æ–°æˆåŠŸ - ${BEIJING_TIME} åŒ—äº¬æ—¶é—´"
        echo "ğŸ“„ æ–‡ä»¶æ ¼å¼: çº¯IPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª"
        echo "ğŸ”¢ IPæ•°é‡: $(wc -l < telecom_ips.txt)"
        echo "ğŸ–¥ï¸ ä½¿ç”¨æŠ€æœ¯: Seleniumæ¨¡æ‹Ÿæµè§ˆå™¨"

    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
        echo "âŒ ç”µä¿¡IPæ›´æ–°å¤±è´¥ - ${BEIJING_TIME} åŒ—äº¬æ—¶é—´"
        echo "è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1
