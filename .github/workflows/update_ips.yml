name: Update Telecom IPs

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'telecom_ips.txt'
      - 'telecom_ips.json'
      - 'logs/**'

env:
  PYTHON_VERSION: '3.9'

jobs:
  update-ips:
    name: æ›´æ–°ç”µä¿¡ä¼˜é€‰IP
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: åˆ›å»ºæ—¥å¿—ç›®å½•
      run: mkdir -p logs

    - name: è¿è¡ŒIPæ›´æ–°è„šæœ¬
      run: |
        python main.py

    - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        echo "æ—¥å¿—ç›®å½•æ–‡ä»¶:"
        ls -la logs/ || echo "æ—¥å¿—ç›®å½•ä¸å­˜åœ¨"

    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: git-check
      run: |
        git add telecom_ips.txt telecom_ips.json logs/
        echo "changes=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT
        echo "æ–‡ä»¶å˜åŒ–æ•°é‡: $(git status --porcelain | wc -l)"

    - name: é…ç½®Gitç”¨æˆ·
      if: steps.git-check.outputs.changes != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: æäº¤æ›´æ”¹
      if: steps.git-check.outputs.changes != '0'
      run: |
        git add telecom_ips.txt telecom_ips.json logs/
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç”µä¿¡ä¼˜é€‰IP - $(date -u +'%Y-%m-%d %H:%M UTC')
        
        - æ›´æ–°IPåœ°å€åˆ—è¡¨
        - æ·»åŠ æ‰§è¡Œæ—¥å¿—"
        git push

    - name: ä¸Šä¼ æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ip-updater-logs
        path: |
          logs/
          telecom_ips.txt
          telecom_ips.json
        retention-days: 7
        if-no-files-found: warn

    - name: æ˜¾ç¤ºä»»åŠ¡æ‘˜è¦
      run: |
        echo "=== ä»»åŠ¡æ‰§è¡Œæ‘˜è¦ ==="
        echo "è¿è¡Œæ—¶é—´: $(date)"
        echo "æ–‡ä»¶å˜åŒ–: ${{ steps.git-check.outputs.changes }}"
        if [ -f telecom_ips.txt ]; then
          echo "ç”Ÿæˆçš„IPæ•°é‡: $(grep -c '^[0-9]' telecom_ips.txt || echo 0)"
        else
          echo "IPæ–‡ä»¶æœªç”Ÿæˆ"
        fi

    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: success() && steps.git-check.outputs.changes != '0'
      run: |
        echo "âœ… ç”µä¿¡IPæ›´æ–°æˆåŠŸ - æ‰¾åˆ°æ–°çš„IPåœ°å€å¹¶å·²æäº¤"
        echo "æŸ¥çœ‹æ›´æ–°çš„æ–‡ä»¶: telecom_ips.txt"

    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ ç”µä¿¡IPæ›´æ–°å¤±è´¥ - è¯·æ£€æŸ¥æ—¥å¿—"
        exit 1
