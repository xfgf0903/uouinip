name: Update Telecom IPs

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'telecom_ips.txt'  # å¿½ç•¥IPæ–‡ä»¶çš„å˜åŒ–ï¼Œé¿å…å¾ªç¯è§¦å‘

env:
  PYTHON_VERSION: '3.9'

jobs:
  update-ips:
    name: æ›´æ–°ç”µä¿¡ä¼˜é€‰IP
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: è¿è¡ŒIPæ›´æ–°è„šæœ¬
      run: |
        python main.py

    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: git-check
      run: |
        git add telecom_ips.txt
        echo "changes=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT

    - name: é…ç½®Gitç”¨æˆ·
      if: steps.git-check.outputs.changes != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: æäº¤æ›´æ”¹
      if: steps.git-check.outputs.changes != '0'
      run: |
        git add telecom_ips.txt
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç”µä¿¡ä¼˜é€‰IP - $(date -u +'%Y-%m-%d %H:%M UTC')"
        git push

    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶ (æˆåŠŸæ—¶)
      if: success() && steps.git-check.outputs.changes != '0'
      uses: actions/upload-artifact@v4
      with:
        name: ip-updater-logs-success
        path: |
          ip_updater.log
          telecom_ips.txt
        retention-days: 3

    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶ (å¤±è´¥æ—¶)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ip-updater-logs-failure
        path: ip_updater.log
        retention-days: 7

    - name: å‘é€æˆåŠŸé€šçŸ¥ (å¯é€‰)
      if: success() && steps.git-check.outputs.changes != '0'
      run: |
        echo "âœ… ç”µä¿¡IPæ›´æ–°æˆåŠŸ - æ‰¾åˆ°æ–°çš„IPåœ°å€å¹¶å·²æäº¤"
        echo "æŸ¥çœ‹æ›´æ–°çš„æ–‡ä»¶: telecom_ips.txt"

    - name: å‘é€å¤±è´¥é€šçŸ¥ (å¯é€‰)
      if: failure()
      run: |
        echo "âŒ ç”µä¿¡IPæ›´æ–°å¤±è´¥ - è¯·æ£€æŸ¥æ—¥å¿—"
        exit 1
